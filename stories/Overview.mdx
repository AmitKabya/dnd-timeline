import { Canvas } from '@storybook/blocks'
import { Basic } from './2 - External/External.stories.tsx'
import { StackedItems, DisabledRows } from './1 - Timeline/Timeline.stories.tsx'

# Overview

#### A headless timeline library, based on [`dnd-kit`](https://docs.dndkit.com/)

- **Headless:** `dnd-timeline` is a headless-ui library, and contains 0 styling, aside from functional styling (position, z-index, etc.).
- **Hook-based:** exposes simple hooks like `useItem` and `useRow`, that should integrate seamlessly into your existing architecture.
- **Flexible:** very slim and flexible by design. `dnd-timeline` exposes utility functions and positional styling, and you can use them in conjunction with you favorite libraries - styling libraries (MUI, tailwindcss, ant-design, etc.), and functional libraries (react-virtual, framer-motion, etc.)
- **Based on [`dnd-kit`](https://docs.dndkit.com/):** all features exposed by the [`dnd-kit`](https://docs.dndkit.com/) library are applicable to dnd-timeline.
- **Performant:** renders only when needed. All the intermediate states and animations are done using css transformations, and require 0 re-renders.
- **RTL:** `dnd-timeline` nativly supports RTL. simply declare one of the parent divs as rtl with `dir="rtl"`, and thats it.

## Features

- **Stacked rows:** Items whose relevance's intersect are stacked on top of each other inside the same row.
- **Snap to Grid:** Items snap into a pre-defined grid when dropped, that can be changed according to zoom level.
- **Time Axis:** An optional time axis can be displayed, with different markers according to zoom level.
- **Time Cursor:** An optional time cursor indicating the current time on top of the timeline.
- **Pan and zoom:** You can zoom by holding <kbd>Ctrl</kbd> and scrolling using the mouse wheel, and pan by holding <kbd>Ctrl + Shift</kbd> scrolling using the mouse wheel.
  <Canvas of={StackedItems} />
- **Dynamically disabled rows and items:** Items and Rows can be disabled according to a client-defined logic.
  <Canvas of={DisabledRows} />
- **Integration with external DnD:** The timeline can be used in conjunction with other DnD interactions in you app, to drag items into and outside of the timeline.
  <Canvas of={Basic} />

## How does it work?

`dnd-timeline` uses the `data` field provided on `dnd-kit`'s `useDraggable` hook, to forward utils to infer time data from the draggable's current location.  
The `Timeline` provider or the `useTimeline` hook also expose a `TimelineBag` which includes a set of helpers to help the use work in the context of the timeline.

In order to handle a change in an item's relevance, all you need to do is to handle the `onDragEnd` event, and use the provided helper to infer the updated item relevance:

```tsx
const onDragEnd = (event: DragEndEvent) => {
  const overedId = event.over?.id.toString()
  if (!overedId) return

  const activeItemId = event.active.id

  const getRelevanceFromDragEvent =
    event.active?.data?.current?.getRelevanceFromDragEvent

  const updatedRelevance = getRelevanceFromDragEvent(event)

  // update item with id activeItemId with the updatedRelevance, or the updated row using overedId
}
```

This is true for all `dnd-kit` supported handlers:

- `onDragStart`
- `onDragEnd`
- `onDragMove`
- `onDragCancel`

`dnd-timeline` adds a set of 3 more handlers, to handle the resize event:

- `onResizeStart`
- `onResizeEnd`
- `onResizeMove`
- `onResizeCancel`

These events act just like the `dnd-kit` event, except that the event looks a bit different:

```ts
type ResizeEvent = {
  active: Omit<Active, 'rect'> // dnd-kit's Active type
  delta: {
    x: number
  }
  direction: DragDirection // 'start' | 'end'
}
```

The resize events' data already contains the updated relevance.

```tsx
const onResizeEnd = (event: ResizeEndEvent) => {
  const updatedRelevance = event.active.data.current?.relevance
  if (!updatedRelevance) return

  const activeItemId = event.active.id

  // update activeItemId's relevance with the updatedRelevance
}
```

### External items

To handle external items, you will need to pass the dnd-timeline's helpers when defining your draggabale items:

```tsx
const { getRelevanceFromDragEvent, millisecondsToPixels } = useTimelineContext()

const { attributes, isDragging, listeners, setNodeRef, transform, transition } =
  useItem({
    id: props.id,
    disabled: props.disabled,
    data: {
      getRelevanceFromDragEvent,
      duration: props.duration, // the getRelevanceFromDragEvent also knows how to handle duration
    },
  })
```

For non-timeline items, like an external item, you will need to provide a `duration` field describing the items duration in milliseconds.  
`dnd-timeline` will use it to infer its location in the timeline when dropped in and pass it through the event for you to add a new timeline item.
